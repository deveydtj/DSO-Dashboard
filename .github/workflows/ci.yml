name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  validate:
    name: Validate Python Code
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Display Python version
      run: python --version
    
    - name: Compile Python syntax
      run: |
        echo "Checking Python syntax..."
        python -m py_compile server.py
        echo "✓ Python syntax check passed"
    
    - name: Run unit tests
      run: |
        echo "Running unit tests..."
        python -m unittest discover -s tests -p "test_*.py" -v
        echo "✓ All tests passed"
    
    - name: Verify no external dependencies
      run: |
        echo "Checking for forbidden imports..."
        # Check for common external dependencies that should not be present
        if find . -name "*.py" ! -path "./.git/*" -exec grep -l "import requests" {} \; 2>/dev/null | grep -q .; then
          echo "❌ ERROR: 'requests' library found - use urllib instead"
          exit 1
        fi
        if find . -name "*.py" ! -path "./.git/*" -exec grep -l "from flask import" {} \; 2>/dev/null | grep -q .; then
          echo "❌ ERROR: 'flask' library found - use http.server instead"
          exit 1
        fi
        if find . -name "*.py" ! -path "./.git/*" -exec grep -l "import aiohttp" {} \; 2>/dev/null | grep -q .; then
          echo "❌ ERROR: 'aiohttp' library found - use urllib instead"
          exit 1
        fi
        echo "✓ No forbidden dependencies found"
    
    - name: Check for secrets in code
      run: |
        echo "Checking for hardcoded secrets..."
        # Check for potential hardcoded tokens or passwords
        if grep -i "token.*=.*['\"][a-zA-Z0-9_-]\{20,\}['\"]" server.py; then
          echo "⚠️  WARNING: Potential hardcoded token found in server.py"
          echo "    Tokens should be in config.json or environment variables"
          exit 1
        fi
        echo "✓ No hardcoded secrets detected"
    
    - name: Validate project structure
      run: |
        echo "Validating project structure..."
        # Check required files exist
        test -f server.py || (echo "❌ server.py missing" && exit 1)
        test -f config.json.example || (echo "❌ config.json.example missing" && exit 1)
        test -f .env.example || (echo "❌ .env.example missing" && exit 1)
        test -f README.md || (echo "❌ README.md missing" && exit 1)
        test -d frontend || (echo "❌ frontend/ directory missing" && exit 1)
        test -f frontend/index.html || (echo "❌ frontend/index.html missing" && exit 1)
        test -f frontend/app.js || (echo "❌ frontend/app.js missing" && exit 1)
        test -f frontend/styles.css || (echo "❌ frontend/styles.css missing" && exit 1)
        test -d tests || (echo "❌ tests/ directory missing" && exit 1)
        echo "✓ Project structure validated"
    
    - name: Verify config.json not committed
      run: |
        echo "Checking that config.json is not committed..."
        if [ -f config.json ]; then
          echo "❌ ERROR: config.json should not be committed (contains secrets)"
          echo "    Only config.json.example should be in the repository"
          exit 1
        fi
        echo "✓ config.json not committed (good)"

  frontend-validation:
    name: Validate Frontend
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for frontend framework imports
      run: |
        echo "Checking for forbidden frontend frameworks..."
        # Check for React, Vue, jQuery, etc.
        if grep -r "from ['\"]react['\"]" frontend/*.js 2>/dev/null; then
          echo "❌ ERROR: React import found - use vanilla JavaScript"
          exit 1
        fi
        if grep -r "from ['\"]vue['\"]" frontend/*.js 2>/dev/null; then
          echo "❌ ERROR: Vue import found - use vanilla JavaScript"
          exit 1
        fi
        if grep -r "jquery" frontend/*.js frontend/*.html 2>/dev/null; then
          echo "❌ ERROR: jQuery found - use vanilla JavaScript"
          exit 1
        fi
        echo "✓ No forbidden frontend frameworks found"
    
    - name: Check for build tool artifacts
      run: |
        echo "Checking for build tool artifacts..."
        # Check that no build tools are present
        if [ -f package.json ] || [ -f package-lock.json ]; then
          echo "❌ ERROR: npm package files found - frontend should be vanilla"
          exit 1
        fi
        if [ -f webpack.config.js ] || [ -f rollup.config.js ]; then
          echo "❌ ERROR: Build tool config found - no build step required"
          exit 1
        fi
        if [ -d node_modules ]; then
          echo "❌ ERROR: node_modules directory found"
          exit 1
        fi
        echo "✓ No build tool artifacts found"
    
    - name: Validate HTML structure
      run: |
        echo "Validating HTML files..."
        # Check that HTML files exist and are not empty
        for file in frontend/*.html; do
          if [ ! -s "$file" ]; then
            echo "❌ ERROR: $file is empty"
            exit 1
          fi
          # Check for basic HTML structure
          if ! grep -q "<html" "$file"; then
            echo "❌ ERROR: $file missing <html> tag"
            exit 1
          fi
        done
        echo "✓ HTML structure validated"
    
    - name: Check for XSS vulnerabilities
      run: |
        echo "Checking for potential XSS vulnerabilities..."
        # Check that escapeHtml function exists
        if ! grep -q "escapeHtml" frontend/app.js; then
          echo "⚠️  WARNING: escapeHtml function not found in app.js"
          echo "    Ensure user input is properly sanitized"
        fi
        echo "✓ XSS prevention check completed"

  integration-test:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [validate, frontend-validation]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Test server startup
      run: |
        echo "Testing server startup (without API token)..."
        # Start server in background
        python3 server.py &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 3
        
        # Check if server is running
        if ! ps -p $SERVER_PID > /dev/null; then
          echo "❌ ERROR: Server failed to start"
          exit 1
        fi
        
        echo "✓ Server started successfully"
        
        # Stop server
        kill $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
    
    - name: Test API endpoints respond
      run: |
        echo "Testing API endpoints..."
        # Start server in background
        python3 server.py &
        SERVER_PID=$!
        
        # Wait for server to be ready
        sleep 3
        
        # Test health endpoint
        if curl -f -s http://localhost:8080/api/health > /dev/null; then
          echo "✓ /api/health endpoint responding"
        else
          echo "⚠️  /api/health endpoint not responding (expected without API token)"
        fi
        
        # Test that frontend HTML is served
        if curl -f -s http://localhost:8080/ | grep -q "<html"; then
          echo "✓ Frontend HTML is served"
        else
          echo "❌ ERROR: Frontend not accessible"
          kill $SERVER_PID 2>/dev/null || true
          exit 1
        fi
        
        # Stop server
        kill $SERVER_PID 2>/dev/null || true
        wait $SERVER_PID 2>/dev/null || true
        
        echo "✓ Integration test completed"

  summary:
    name: CI Summary
    runs-on: ubuntu-latest
    needs: [validate, frontend-validation, integration-test]
    if: always()
    
    steps:
    - name: Check results
      run: |
        echo "CI Pipeline Summary"
        echo "==================="
        echo ""
        echo "Validation: ${{ needs.validate.result }}"
        echo "Frontend Validation: ${{ needs.frontend-validation.result }}"
        echo "Integration Test: ${{ needs.integration-test.result }}"
        echo ""
        
        if [ "${{ needs.validate.result }}" = "success" ] && \
           [ "${{ needs.frontend-validation.result }}" = "success" ] && \
           [ "${{ needs.integration-test.result }}" = "success" ]; then
          echo "✓ All checks passed!"
          exit 0
        else
          echo "❌ Some checks failed"
          exit 1
        fi
